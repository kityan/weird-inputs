!function(){function t(t,e){this.timeout=50,this.tm=null,this.values={w:null,h:null},this.element=t||window,this.handler=e||function(){},this.tm=setTimeout(this.checker.bind(this),this.timeout),this.rnd=Math.random()}t.prototype.destroy=function(){clearTimeout(this.tm)},t.prototype.checker=function(){var t=parseInt(this.element.style("width")),e=parseInt(this.element.style("height"));(this.values.w&&this.values.w!=t||this.values.h&&this.values.h!=e)&&setTimeout(this.handler.bind(this),0),this.values.w=t,this.values.h=e,this.tm=setTimeout(this.checker.bind(this),this.timeout)};var e=angular.module("weird-inputs",[]);e.directive("lineChartInput",["$window","$filter",function(e,n){return{restrict:"EA",template:'<svg class="lineChartInputGraph" style="width:100%; height: 100%"></svg><svg class="lineChartInputPopup" viewBox="0 0 150 45"></svg>',scope:{points:"=",options:"=",activePoint:"=?"},link:function(n,i,a){function s(){T=parseInt(L.style("width")),_=parseInt(L.style("height")),r(),L.selectAll("*").remove(),c()}function o(){n.options&&n.points&&(F?l():c())}function r(){v=P.scale.linear().domain([new Date(n.points[0].dt),new Date(n.points[n.points.length-1].dt)]).range([$.left,T-$.right]),g=P.scale.linear().domain([n.options.min,n.options.max]).range([_-$.bottom,$.top]),b=g(n.options.max-n.options.step)-g(n.options.max),m=g(n.options.max),w=g(n.options.min),f=P.svg.line().x(function(t,e){return v(new Date(t.dt))}).y(function(t){return g(t.value)}).interpolate(n.options.lineInterpolation),x=P.svg.axis().scale(g).orient("left").tickValues([n.options.min,n.options.max]),xAxisGen=P.svg.axis().scale(v).orient("bottom").tickValues(n.points.map(function(t){return t.dt})).tickFormat(function(t){return n.options.shortYearLabels?"'"+new Date(t).getFullYear().toString().substr(2,2):new Date(t).getFullYear()}),y=P.behavior.drag().on("dragstart",d).on("drag",u).on("dragend",h)}function l(){L.select("path.line").attr({d:f(n.points)}),L.selectAll("circle.point").data(n.points).attr("cy",function(t){return g(t.value)})}function p(t,e,i){var a=L.append("svg:g").attr("class","grid");if(!i||!i.y)for(var s=0;s<=t;s++){var o=Math.round(s*(_-$.top-$.bottom)/t+$.top);n.options.level&&Math.abs(g(n.options.level)-o)<1||a.append("svg:line").attr("class","yGrid").attr("x1",$.left-C.yLeft).attr("y1",o).attr("x2",T-$.right+C.yRight).attr("y2",o)}if(!i||!i.x)for(var r=n.points.length/e,s=0;s<n.points.length;s++)if(s%r===0||s==n.points.length-1){var l=Math.round(v(n.points[s].dt));a.append("svg:line").attr("class","xGrid").attr("x1",l).attr("y1",$.top-C.xTop).attr("x2",l).attr("y2",_-$.bottom+C.xBottom)}}function c(){r(),p(n.options.grid.y?n.options.grid.y:6,n.options.grid.x?n.options.grid.x:6,n.options.hideGrid),L.append("svg:g").attr("class","axis yAxis").attr("transform","translate("+($.left-C.yLeft)+", 0)").call(x),L.append("svg:g").attr("class","axis xAxis").attr("transform","translate(0, "+(w-C.xBottom)+")").call(xAxisGen),L.append("svg:path").attr({d:f(n.points),"class":D}),(n.options.level||0===n.options.level)&&(L.append("svg:line").attr("class","level").attr("x1",$.left-C.yLeft).attr("y1",g(n.options.level)).attr("x2",T+C.yRight-$.right).attr("y2",g(n.options.level)),L.append("svg:text").attr("class","level").attr("alignment-baseline","middle").attr("x",$.left-C.yLeft-9).attr("y",g(n.options.level)).text(P.format(",")(n.options.level))),L.selectAll("circle.point").data(n.points).enter().append("svg:circle").attr("class",function(t,e){return"point"+(t.readonly?" readonly":"")}).attr("id",function(t,e){return"circle_"+e}).attr("cx",function(t){return v(new Date(t.dt))}).attr("cy",function(t){return g(t.value)}).attr("r",function(t,e){return t.readonly?3:10}).call(y),I=M.append("svg:g").attr("class","popup"),I.append("svg:path").attr("d","M 0,0 0,30 60,30 75,44 90,30 150,30 150,0 0,0 Z"),k=I.append("svg:text").attr("transform","translate(75, 20)").text(""),F=!0}function d(){var t=P.select(P.event.sourceEvent.target);t.classed("readonly")||L.classed("whileDragging",!0);var e=t.attr("cx"),i=t.attr("cy"),a=g.invert(i).toFixed(n.options.precision);n.$apply(function(){n.activePoint={index:1*t.attr("id").replace("circle_",""),value:1*a}}),k.text(a),n.options.hidePopup||M.style("display","block").style("transform","translate("+(e-A.x)+"px,"+(i-A.y)+"px)").style("-webkit-transform","translate("+(e-A.x)+"px,"+(i-A.y)+"px)");var s=P.select(this);s.attr("id").split("_")}function u(){var t=P.event.y,e=(P.event.x,P.select(this));if(!e.classed("readonly")){var i=1*e.attr("cy"),a=1*e.attr("cx");t=i+Math.round((t-i)/b)*b,t=t<m?m:t,t=t>w?w:t;var s=e.attr("id").split("_");n.$apply(function(){var o=g.invert(t).toFixed(n.options.precision);n.points[1*s[1]].value=1*o,l(),n.activePoint={index:1*e.attr("id").replace("circle_",""),value:1*o},n.options.hidePopup||(M.style("transform","translate("+(a-A.x)+"px,"+(i-A.y)+"px)"),M.style("-webkit-transform","translate("+(a-A.x)+"px,"+(i-A.y)+"px)")),k.text(o)})}}function h(){L.classed("whileDragging",!1),n.$apply(function(){n.activePoint=null}),n.options.hidePopup||M.style("display","none");var t=P.select(this);t.attr("id").split("_")}i.addClass("lineChartInput");var v,g,x,f,y,m,w,b,I,k,A={x:75,y:60},$={left:80,right:30,top:30,bottom:80},D="line",P=e.d3,G=i.find("svg"),L=P.select(G[0]),M=P.select(G[1]),T=parseInt(L.style("width")),_=parseInt(L.style("height")),C={yLeft:20,yRight:20,xTop:0,xBottom:0},F=!1,B=new t(L,s);n.$on("$destroy",function(){B.destroy()}),n.$watch("points",o,!0),n.$watch("options",function(){n.points&&(L.selectAll("*").remove(),c())},!0)}}}])}();